import React, { useState, useEffect, useRef } from 'react';
import { Shield, Bell, Eraser, AlertTriangle, Activity, ChevronRight, ChevronLeft, RefreshCw, Lock, Scan, CheckCircle2, Terminal, Power, Fingerprint, Grip, Cpu } from 'lucide-react';

// --- HELPER COMPONENTS ---

// Decrypting Text Effect
const DecryptText = ({ text, reveal = true }) => {
  const [display, setDisplay] = useState('');
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789@#$%&';

  useEffect(() => {
    if (!reveal) return;
    
    let iterations = 0;
    const interval = setInterval(() => {
      setDisplay(
        text
          .split('')
          .map((letter, index) => {
            if (index < iterations) return text[index];
            return chars[Math.floor(Math.random() * chars.length)];
          })
          .join('')
      );

      if (iterations >= text.length) clearInterval(interval);
      iterations += 1 / 2; // Speed of decryption
    }, 30);

    return () => clearInterval(interval);
  }, [text, reveal]);

  return <span>{display}</span>;
};

// Typewriter Effect for Descriptions
const Typewriter = ({ text, speed = 15 }) => {
  const [displayedText, setDisplayedText] = useState('');

  useEffect(() => {
    setDisplayedText('');
    let i = 0;
    const timer = setInterval(() => {
      if (i < text.length) {
        setDisplayedText((prev) => prev + text.charAt(i));
        i++;
      } else {
        clearInterval(timer);
      }
    }, speed);
    return () => clearInterval(timer);
  }, [text, speed]);

  return <p className="leading-relaxed">{displayedText}<span className="animate-pulse text-blue-400">_</span></p>;
};

// --- MAIN COMPONENT ---

const QuickStartSheet = () => {
  const [currentStep, setCurrentStep] = useState(0);
  const [isBooting, setIsBooting] = useState(false);
  const [bootProgress, setBootProgress] = useState(0);
  const [acquiredItems, setAcquiredItems] = useState([]);

  // Content Data
  const items = [
    {
      id: 1,
      category: "Privacy Shield",
      object: "Mirrored Sunglasses",
      icon: <Shield className="w-32 h-32 text-cyan-300 drop-shadow-[0_0_35px_rgba(103,232,249,0.8)]" />,
      description: "We chose mirrored sunglasses because they allow you to see out while preventing others from seeing in. In the digital world, this represents curating your settings to observe the internet without letting algorithms track your every move."
    },
    {
      id: 2,
      category: "Alert System",
      object: "Toy Canary",
      icon: <Bell className="w-32 h-32 text-yellow-400 drop-shadow-[0_0_35px_rgba(250,204,21,0.8)]" />,
      description: "Representing the 'canary in the coal mine.' This item symbolizes the need to notice small warning signs—like a strange login notification or a slow device—before a toxic security breach occurs."
    },
    {
      id: 3,
      category: "Cleanup Tool",
      object: "Bottle of White-Out",
      icon: <Eraser className="w-32 h-32 text-white drop-shadow-[0_0_35px_rgba(255,255,255,0.8)]" />,
      description: "Unlike an eraser, White-Out covers a mistake but leaves the bumps underneath. This symbolizes that 'deleting' a post doesn't remove it from servers or screenshots. It's merely painted over, but the data remains."
    },
    {
      id: 4,
      category: "False Security Warning",
      object: "Window Screen Mesh",
      icon: <AlertTriangle className="w-32 h-32 text-orange-500 drop-shadow-[0_0_35px_rgba(249,115,22,0.8)]" />,
      myth: "Myth: 'Private/Incognito Mode makes me invisible.'",
      description: "A screen door feels like a wall, but light and sound pass right through. Similarly, Incognito Mode only stops your browser from saving history. It is completely transparent to your ISP, school network, and the websites you visit."
    },
    {
      id: 5,
      category: "Resilience Reminder",
      object: "A Superball",
      icon: <Activity className="w-32 h-32 text-emerald-400 drop-shadow-[0_0_35px_rgba(52,211,153,0.8)]" />,
      description: "When a glass falls, it shatters. When a superball falls, it bounces back. This reminds us that when our identity is threatened (leaks, hacks, bullying), we must not shatter. We reset our passwords, report the issue, and bounce back."
    }
  ];

  const totalSlides = items.length + 2;

  // Handle Boot Sequence
  const handleStart = () => {
    setIsBooting(true);
    let progress = 0;
    const interval = setInterval(() => {
      progress += Math.random() * 10;
      if (progress >= 100) {
        progress = 100;
        clearInterval(interval);
        setTimeout(() => {
          setIsBooting(false);
          handleNext();
        }, 800);
      }
      setBootProgress(progress);
    }, 150);
  };

  const handleNext = () => {
    if (currentStep < totalSlides - 1) {
      setCurrentStep(prev => prev + 1);
      // Add item to acquired list if it's an item slide
      if (currentStep >= 0 && currentStep < items.length) {
         const itemId = items[currentStep]?.id; // currentStep 0 is intro, so item index is currentStep
         if(itemId) setAcquiredItems(prev => [...new Set([...prev, itemId])]);
      }
    }
  };

  const handlePrev = () => {
    if (currentStep > 0) {
      setCurrentStep(prev => prev - 1);
    }
  };

  const jumpToStep = (step) => {
    setCurrentStep(step);
  };

  const restart = () => {
    setAcquiredItems([]);
    setCurrentStep(0);
  };

  // Keyboard Navigation
  useEffect(() => {
    const handleKeyDown = (e) => {
      if (e.key === 'ArrowRight' && !isBooting) handleNext();
      if (e.key === 'ArrowLeft' && !isBooting) handlePrev();
    };
    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [currentStep, isBooting]);

  const renderContent = () => {
    // --- BOOT SCREEN ---
    if (isBooting) {
      return (
        <div className="flex flex-col items-center justify-center h-full w-full max-w-lg mx-auto space-y-8 z-20">
          <div className="relative">
            <div className="absolute inset-0 bg-emerald-500 blur-2xl opacity-20 animate-pulse"></div>
            <Fingerprint className="w-32 h-32 text-emerald-500 animate-scan" />
            <div className="absolute top-0 left-0 w-full h-1 bg-emerald-400 blur-[2px] animate-scan-line"></div>
          </div>
          
          <div className="w-full space-y-2">
            <div className="flex justify-between text-xs font-mono text-emerald-500">
              <span>SYSTEM_CHECK</span>
              <span>{Math.round(bootProgress)}%</span>
            </div>
            <div className="h-2 bg-slate-900 rounded-full overflow-hidden border border-emerald-900">
              <div 
                className="h-full bg-emerald-500 transition-all duration-200 ease-out relative"
                style={{ width: `${bootProgress}%` }}
              >
                <div className="absolute right-0 top-0 h-full w-2 bg-white blur-[2px]"></div>
              </div>
            </div>
          </div>

          <div className="font-mono text-emerald-500/80 text-sm space-y-1 h-24 overflow-hidden text-left w-full p-4 bg-black/40 rounded border border-emerald-900/50">
             {bootProgress > 10 && <p>{'>'} MOUNTING VIRTUAL DRIVES...</p>}
             {bootProgress > 30 && <p>{'>'} BYPASSING FIREWALLS...</p>}
             {bootProgress > 60 && <p>{'>'} DECRYPTING IDENTITY ASSETS...</p>}
             {bootProgress > 90 && <p>{'>'} ACCESS GRANTED.</p>}
          </div>
        </div>
      );
    }

    // --- INTRO SLIDE ---
    if (currentStep === 0) {
      return (
        <div className="flex flex-col items-center justify-center text-center h-full space-y-10 animate-in fade-in zoom-in duration-700 relative z-20">
          
          <div className="relative group">
            <div className="absolute -inset-1 bg-gradient-to-r from-blue-600 to-cyan-600 rounded-full blur opacity-40 group-hover:opacity-75 transition duration-1000 group-hover:duration-200"></div>
            <div className="relative bg-slate-900 p-8 rounded-full border border-slate-700 shadow-2xl">
              <Lock className="w-24 h-24 text-blue-400" />
            </div>
            
            {/* Spinning Rings */}
            <div className="absolute inset-0 border border-blue-500/20 rounded-full w-full h-full scale-150 animate-spin-slow-reverse pointer-events-none"></div>
            <div className="absolute inset-0 border-t border-cyan-400/50 rounded-full w-full h-full scale-125 animate-spin-slow pointer-events-none"></div>
          </div>
          
          <div className="space-y-6 max-w-4xl">
            <div className="inline-block px-4 py-1 rounded bg-blue-900/30 border border-blue-500/30 text-blue-300 font-mono text-xs tracking-[0.3em] mb-4">
              CLASSIFIED // GROUP 01
            </div>
            <h1 className="text-6xl md:text-8xl font-black text-transparent bg-clip-text bg-gradient-to-b from-white to-slate-500 drop-shadow-2xl">
              GLASS HOUSE
            </h1>
            <p className="text-slate-400 text-xl md:text-2xl font-light max-w-2xl mx-auto border-l-2 border-blue-500 pl-6 text-left">
              <span className="text-white font-bold block mb-1">Mission Objective:</span>
              Assemble a tactical defense inventory to survive in an age of total digital transparency.
            </p>
          </div>

          <button 
            onClick={handleStart}
            className="group relative bg-white text-slate-900 px-10 py-5 rounded-xl font-bold text-lg tracking-wider overflow-hidden transition-all hover:scale-105 active:scale-95 shadow-[0_0_40px_rgba(255,255,255,0.3)]"
          >
            <div className="absolute inset-0 bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-600 opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
            <span className="relative z-10 flex items-center gap-3 group-hover:text-white transition-colors">
              <Power className="w-5 h-5" /> INITIALIZE SYSTEM
            </span>
          </button>
        </div>
      );
    }

    // --- OUTRO SLIDE ---
    if (currentStep === items.length + 1) {
      return (
        <div className="flex flex-col items-center justify-center text-center h-full w-full max-w-5xl mx-auto z-20 animate-in fade-in duration-700">
          <div className="w-full bg-slate-900/60 backdrop-blur-xl border border-emerald-500/30 p-12 rounded-3xl relative overflow-hidden group">
            
            {/* Success Animation Background */}
            <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-emerald-900/20 via-slate-900/50 to-slate-900/90"></div>
            
            <div className="relative z-10 flex flex-col items-center">
              <div className="w-20 h-20 bg-emerald-500/10 rounded-full flex items-center justify-center mb-8 border border-emerald-500/50 shadow-[0_0_30px_rgba(16,185,129,0.2)]">
                <CheckCircle2 className="w-10 h-10 text-emerald-400" />
              </div>

              <h2 className="text-4xl md:text-6xl font-black text-white mb-8 tracking-tight">
                <DecryptText text="PROTOCOL COMPLETE" />
              </h2>

              <div className="prose prose-invert prose-lg max-w-3xl">
                <p className="text-3xl font-serif italic text-slate-200 leading-normal">
                  "If it is free, you are the product. <br/>If it is digital, it is permanent."
                </p>
                <div className="my-8 h-px bg-gradient-to-r from-transparent via-slate-500 to-transparent"></div>
                <p className="text-slate-400 font-mono text-sm uppercase tracking-widest">
                  Warning: Assume everything you post is being viewed on a billboard by your future employer.
                </p>
              </div>
            </div>
          </div>

          <button 
            onClick={restart}
            className="mt-12 flex items-center gap-3 text-slate-500 hover:text-white transition-colors uppercase tracking-widest text-xs font-bold"
          >
            <RefreshCw className="w-4 h-4" /> Reset Simulation
          </button>
        </div>
      );
    }

    // --- ITEM SLIDES ---
    const itemIndex = currentStep - 1;
    const item = items[itemIndex];
    const isCollected = acquiredItems.includes(item.id);

    return (
      <div 
        key={item.id}
        className="grid grid-cols-1 lg:grid-cols-12 gap-8 items-center h-full w-full max-w-7xl px-6 relative z-20 animate-in slide-in-from-right-8 duration-500 fade-in"
      >
        
        {/* Left Col: 3D Visualization */}
        <div className="lg:col-span-5 flex flex-col items-center justify-center order-2 lg:order-1">
          <div className="relative w-full aspect-square max-w-[400px] flex items-center justify-center group perspective-container">
            
            {/* Holographic Platform */}
            <div className="absolute bottom-[10%] w-[60%] h-[20%] bg-blue-500/10 rounded-[100%] blur-md transform rotate-x-60"></div>
            
            {/* The Item Icon - Floating */}
            <div className="relative z-10 transform transition-transform duration-700 group-hover:scale-110 animate-float">
               {item.icon}
            </div>

            {/* Rotating Rings */}
            <div className="absolute w-full h-full border border-white/5 rounded-full animate-spin-slow-reverse opacity-20"></div>
            <div className="absolute w-[80%] h-[80%] border-l border-r border-blue-500/30 rounded-full animate-spin-slow"></div>

            {/* Collected Badge */}
            {isCollected && (
               <div className="absolute top-0 right-0 bg-emerald-500 text-slate-900 px-3 py-1 text-xs font-bold uppercase tracking-wider rounded-bl-xl shadow-[0_0_20px_rgba(16,185,129,0.5)] animate-bounce-in">
                 Secured
               </div>
            )}
          </div>
          
          <div className="mt-8 text-center">
            <h2 className="text-5xl font-black text-white tracking-tighter mb-2">
              <DecryptText text={item.object.toUpperCase()} />
            </h2>
            <div className="text-blue-400 font-mono text-sm tracking-[0.4em] uppercase opacity-70">
              Artifact No. 0{item.id}
            </div>
          </div>
        </div>

        {/* Right Col: Data & Analysis */}
        <div className="lg:col-span-7 flex flex-col space-y-6 order-1 lg:order-2 bg-slate-900/40 backdrop-blur-md p-8 rounded-[2rem] border border-white/10 shadow-2xl relative overflow-hidden">
          
          {/* Decorative Corner lines */}
          <div className="absolute top-0 left-0 w-16 h-16 border-t-2 border-l-2 border-blue-500/30 rounded-tl-2xl"></div>
          <div className="absolute bottom-0 right-0 w-16 h-16 border-b-2 border-r-2 border-blue-500/30 rounded-br-2xl"></div>

          {/* Header */}
          <div className="flex items-center gap-4 border-b border-white/10 pb-4">
             <div className="bg-blue-500/20 p-2 rounded-lg text-blue-400">
               <Grip className="w-5 h-5" />
             </div>
             <div>
               <div className="text-[10px] text-slate-500 uppercase tracking-wider">Category</div>
               <div className="text-xl font-bold text-white">{item.category}</div>
             </div>
             <div className="ml-auto flex items-center gap-2 px-3 py-1 bg-slate-800 rounded-full border border-slate-700">
                <div className={`w-2 h-2 rounded-full ${item.myth ? 'bg-orange-500' : 'bg-emerald-500'} animate-pulse`}></div>
                <span className="text-[10px] font-mono uppercase text-slate-400">{item.myth ? 'THREAT DETECTED' : 'SECURE'}</span>
             </div>
          </div>

          {/* Myth Alert */}
          {item.myth && (
            <div className="relative bg-gradient-to-r from-orange-950/80 to-slate-900 border-l-4 border-orange-500 p-6 rounded-r-xl overflow-hidden group">
              <div className="absolute -right-6 -top-6 text-orange-500/10 group-hover:text-orange-500/20 transition-all rotate-12">
                <AlertTriangle size={120} />
              </div>
              <div className="relative z-10">
                <h4 className="text-orange-500 font-bold text-xs uppercase tracking-widest mb-2 flex items-center gap-2">
                   <AlertTriangle className="w-4 h-4" /> Digital Myth Identified
                </h4>
                <p className="text-orange-200 text-lg italic font-serif">"{item.myth}"</p>
              </div>
            </div>
          )}

          {/* Typewriter Description */}
          <div className="bg-black/30 p-6 rounded-xl border border-white/5 font-mono text-sm md:text-base text-slate-300 shadow-inner h-[200px] overflow-y-auto custom-scrollbar">
             <Typewriter text={item.description} speed={20} />
          </div>

          <div className="pt-2 text-[10px] text-slate-600 font-mono text-right">
             DATA_BLOCK_ID: {Math.random().toString(36).substr(2, 9).toUpperCase()}
          </div>
        </div>
      </div>
    );
  };

  return (
    <div className="h-screen w-full bg-slate-950 text-slate-100 font-sans overflow-hidden relative flex flex-col">
      
      {/* --- BACKGROUND LAYER --- */}
      <div className="fixed inset-0 z-0 pointer-events-none">
        {/* Moving Grid Floor */}
        <div className="absolute inset-0 perspective-grid">
           <div className="grid-plane"></div>
        </div>
        {/* Ambient Gradient Mesh */}
        <div className="absolute top-[-20%] left-[-20%] w-[60%] h-[60%] bg-blue-900/20 rounded-full blur-[150px] animate-pulse-slow"></div>
        <div className="absolute bottom-[-20%] right-[-20%] w-[60%] h-[60%] bg-emerald-900/10 rounded-full blur-[150px] animate-pulse-slow delay-1000"></div>
        {/* Noise Texture */}
        <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-[0.04]"></div>
        {/* Scanlines */}
        <div className="absolute inset-0 scanlines opacity-10"></div>
      </div>

      {/* --- MAIN CONTENT AREA --- */}
      <main className="flex-grow flex items-center justify-center relative w-full h-full">
        {renderContent()}
      </main>

      {/* --- HUD FOOTER --- */}
      <footer className="z-30 h-20 bg-slate-900/80 backdrop-blur-xl border-t border-slate-800 flex items-center px-4 md:px-8 justify-between shrink-0">
        
        {/* Left: Nav Controls */}
        <div className="flex items-center gap-4">
           <button 
             onClick={handlePrev} 
             disabled={currentStep === 0 || isBooting}
             className="w-10 h-10 flex items-center justify-center rounded-lg border border-slate-700 text-slate-400 hover:bg-white/10 hover:text-white disabled:opacity-30 disabled:cursor-not-allowed transition-all"
           >
             <ChevronLeft className="w-5 h-5" />
           </button>
           <div className="hidden md:block h-8 w-px bg-slate-700"></div>
           <div className="text-xs font-mono text-slate-500 hidden md:block">
              STEP {currentStep}/{totalSlides - 1}
           </div>
        </div>

        {/* Center: Inventory Progress */}
        <div className="flex items-center gap-2">
           {items.map((item, idx) => {
             const isOwned = acquiredItems.includes(item.id);
             const isCurrent = currentStep === idx + 1;
             return (
               <button 
                 key={item.id}
                 onClick={() => !isBooting && jumpToStep(idx + 1)}
                 className={`
                   relative w-12 h-2 md:h-3 rounded-sm transition-all duration-300
                   ${isOwned ? 'bg-blue-500 shadow-[0_0_10px_rgba(59,130,246,0.5)]' : 'bg-slate-800'}
                   ${isCurrent ? 'ring-2 ring-white scale-110 z-10' : 'hover:bg-slate-700'}
                 `}
                 title={item.object}
               >
                 {isCurrent && <div className="absolute -top-10 left-1/2 -translate-x-1/2 text-[10px] bg-slate-800 px-2 py-1 rounded border border-slate-600 whitespace-nowrap hidden md:block">{item.object}</div>}
               </button>
             );
           })}
        </div>

        {/* Right: Next Action */}
        <div>
           <button 
             onClick={handleNext}
             disabled={currentStep === totalSlides - 1 || isBooting}
             className="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold text-sm tracking-wide flex items-center gap-2 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:shadow-blue-500/40 active:transform active:translate-y-px"
           >
             <span>{currentStep === 0 ? 'START' : 'NEXT'}</span> <ChevronRight className="w-4 h-4" />
           </button>
        </div>

      </footer>

      {/* --- GLOBAL STYLES --- */}
      <style>{`
        /* 3D Grid Animation */
        .perspective-grid {
          perspective: 1000px;
          overflow: hidden;
        }
        .grid-plane {
          position: absolute;
          width: 300%;
          height: 300%;
          left: -100%;
          top: -100%;
          background-image: 
            linear-gradient(rgba(59, 130, 246, 0.1) 1px, transparent 1px),
            linear-gradient(90deg, rgba(59, 130, 246, 0.1) 1px, transparent 1px);
          background-size: 50px 50px;
          transform: rotateX(70deg) translateY(0);
          animation: grid-move 20s linear infinite;
        }
        @keyframes grid-move {
          0% { transform: rotateX(70deg) translateY(0); }
          100% { transform: rotateX(70deg) translateY(50px); }
        }

        /* Scanlines */
        .scanlines {
          background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.2) 50%, rgba(0,0,0,0.2));
          background-size: 100% 4px;
        }

        /* Animations */
        @keyframes scan {
          0% { opacity: 0.5; transform: scale(1); }
          50% { opacity: 1; transform: scale(1.05); }
          100% { opacity: 0.5; transform: scale(1); }
        }
        .animate-scan { animation: scan 2s infinite ease-in-out; }
        
        @keyframes scan-line {
          0% { top: 0%; opacity: 0; }
          10% { opacity: 1; }
          90% { opacity: 1; }
          100% { top: 100%; opacity: 0; }
        }
        .animate-scan-line { animation: scan-line 2s infinite ease-in-out; }

        @keyframes float {
          0%, 100% { transform: translateY(0px); }
          50% { transform: translateY(-15px); }
        }
        .animate-float { animation: float 6s ease-in-out infinite; }

        @keyframes spin-slow { 
          from { transform: rotate(0deg); } 
          to { transform: rotate(360deg); } 
        }
        .animate-spin-slow { animation: spin-slow 20s linear infinite; }

        @keyframes spin-slow-reverse { 
          from { transform: rotate(360deg); } 
          to { transform: rotate(0deg); } 
        }
        .animate-spin-slow-reverse { animation: spin-slow-reverse 25s linear infinite; }

        /* Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(59, 130, 246, 0.5); border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: rgba(59, 130, 246, 0.8); }
      `}</style>
    </div>
  );
};

export default QuickStartSheet;
